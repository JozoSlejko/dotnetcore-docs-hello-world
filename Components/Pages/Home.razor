@page "/home"

@inject HttpClient Http
@implements IAsyncDisposable

<h3>Home</h3>

@if (isLoading)
{
    <p>Loading...</p>
}
else if (!string.IsNullOrEmpty(emailAddress))
{
    <p>Email: @emailAddress</p>
    <a href="https://windows.cloud">Windows Cloud</a>
}
else
{
    <p>Please log in.</p>
}

@code {
    private string emailAddress;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        emailAddress = await GetEmailAddressAsync();
        isLoading = false;
    }

    private async Task<string> GetEmailAddressAsync()
    {
        int attempts = 0;
        while (attempts < 12)
        {
            try
            {
                var response = await Http.GetAsync("/.auth/me");
                response.EnsureSuccessStatusCode();
                var content = await response.Content.ReadAsStringAsync();
                var json = JsonSerializer.Deserialize<JsonElement>(content);
                return json.GetProperty("emailaddress").GetString();
            }
            catch
            {
                // Log or handle the exception as needed
            }
            attempts++;
            await Task.Delay(250);
        }
        return null;
    }
}