@page "/"
@using System.Security.Claims
@using Microsoft.AspNetCore.Components.Authorization
@implements IDisposable
@inject AuthenticationStateProvider AuthenticationStateProvider

<PageTitle>Home</PageTitle>

<h1>Hello, world!</h1>

Welcome to your new app.

<a href="/.auth/login/aad">Log in with Microsoft Entra</a>
<a href="/.auth/login/slejcooidc">Log in with Slejco OIDC</a>

@if (_hasEmailAddressClaim)
{
    <p style="margin-top: 1rem;">
        <a href="@WindowsCloudUrl" target="_blank" rel="noopener noreferrer">
            Open Windows Cloud
        </a>
    </p>
}

@code {
    private const string EmailAddressClaimType =
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress";

    private const string WindowsCloudBaseUrl =
        "https://windows.cloud.microsoft/webclient/avd/d8817eb0-d704-4641-a3dd-70025b07ae56/df0c4b56-b1ff-43f0-8fd4-08de563faf68";

    private string WindowsCloudUrl { get; set; } = WindowsCloudBaseUrl;
    private bool _hasEmailAddressClaim;

    protected override async Task OnInitializedAsync()
    {
        AuthenticationStateProvider.AuthenticationStateChanged += OnAuthenticationStateChanged;
        await RefreshAsync();
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> _)
    {
        await RefreshAsync();
        await InvokeAsync(StateHasChanged);
    }

    private async Task RefreshAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        var email = user?.FindFirst(EmailAddressClaimType)?.Value;

        _hasEmailAddressClaim = !string.IsNullOrWhiteSpace(email);

        WindowsCloudUrl = _hasEmailAddressClaim
            ? $"{WindowsCloudBaseUrl}#loginHint={Uri.EscapeDataString(email!)}"
            : WindowsCloudBaseUrl;
    }

    public void Dispose()
    {
        AuthenticationStateProvider.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }
}