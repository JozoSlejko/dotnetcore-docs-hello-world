@page "/"
@using System.Net.Http.Json
@inject HttpClient Http

<PageTitle>Home</PageTitle>

<h1>Hello to AVD!</h1>

<a href="/.auth/login/aad">Log in with Microsoft Entra</a>
<a href="/.auth/login/slejcooidc">Log in with Slejco OIDC</a>

@if (_hasEmail)
{
    <p style="margin-top: 1rem;">
        <a href="@WindowsCloudUrl" target="_blank" rel="noopener noreferrer">
            Open AVD
        </a>
    </p>
}

@code {
    private const string EmailAddressClaimType =
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress";

    private const string WindowsCloudBaseUrl =
        "https://windows.cloud.microsoft/webclient/avd/d8817eb0-d704-4641-a3dd-70025b07ae56/df0c4b56-b1ff-43f0-8fd4-08de563faf68";

    private bool _hasEmail;
    private string WindowsCloudUrl { get; set; } = WindowsCloudBaseUrl;

    protected override async Task OnInitializedAsync()
    {
        await RefreshFromAuthMeWithRetryAsync();
    }

    private async Task RefreshFromAuthMeWithRetryAsync()
    {
        // Retry a few seconds to handle post-login redirect/cookie timing.
        const int maxAttempts = 12;

        for (var attempt = 1; attempt <= maxAttempts; attempt++)
        {
            if (await TryRefreshFromAuthMeAsync())
            {
                break;
            }

            await Task.Delay(250);
        }
    }

    private async Task<bool> TryRefreshFromAuthMeAsync()
    {
        try
        {
            var auth = await Http.GetFromJsonAsync<AuthMeResponse[]>("/.auth/me");

            var claims = auth?.FirstOrDefault()?.user_claims;

            var email = claims?
                .FirstOrDefault(c => c.typ == EmailAddressClaimType)
                ?.val;

            if (string.IsNullOrWhiteSpace(email))
            {
                _hasEmail = false;
                WindowsCloudUrl = WindowsCloudBaseUrl;
                return false;
            }

            _hasEmail = true;
            WindowsCloudUrl = $"{WindowsCloudBaseUrl}#loginHint={Uri.EscapeDataString(email)}";
            return true;
        }
        catch
        {
            _hasEmail = false;
            WindowsCloudUrl = WindowsCloudBaseUrl;
            return false;
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    // DTOs matching /.auth/me shape (only fields we need)
    private sealed class AuthMeResponse
    {
        public ClaimItem[]? user_claims { get; set; }
    }

    private sealed class ClaimItem
    {
        public string? typ { get; set; }
        public string? val { get; set; }
    }
}
