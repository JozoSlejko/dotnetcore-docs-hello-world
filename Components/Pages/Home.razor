@page "/"
@using System.Net.Http.Headers
@using System.Net.Http.Json
@inject IHttpClientFactory HttpClientFactory
@inject IHttpContextAccessor HttpContextAccessor

<PageTitle>Home</PageTitle>

<h1>Hello to AVD!</h1>

<p style="margin-top: 1rem;">
    <a href="/.auth/login/aad">Log in with Microsoft</a>
</p>

<p style="margin-top: 0.75rem;">
    <a href="/.auth/login/slejcooidc">Log in with Slejco OIDC</a>
</p>

@if (_hasEmail)
{
    <p style="margin-top: 1rem;">
        <a href="@WindowsCloudUrl" target="_blank" rel="noopener noreferrer">
            Open AVD
        </a>
    </p>

    <p style="margin-top: 2rem;">
        <a href="/.auth/logout?post_logout_redirect_uri=/">
            Logout
        </a>
    </p>
}

@code {
    private const string EmailAddressClaimType =
        "http://schemas.xmlsoap.org/ws/2005/05/identity/claims/emailaddress";

    private const string WindowsCloudBaseUrl =
        "https://windows.cloud.microsoft/webclient/avd/d8817eb0-d704-4641-a3dd-70025b07ae56/df0c4b56-b1ff-43f0-8fd4-08de563faf68?tenant=2244edc1-992d-4046-ac5a-c1a5250f6a42";

    private bool _hasEmail;
    private string WindowsCloudUrl { get; set; } = WindowsCloudBaseUrl;

    protected override async Task OnInitializedAsync()
    {
        await RefreshFromAuthMeWithRetryAsync();
    }

    private async Task RefreshFromAuthMeWithRetryAsync()
    {
        const int maxAttempts = 12;

        for (var attempt = 1; attempt <= maxAttempts; attempt++)
        {
            if (await TryRefreshFromAuthMeAsync())
                break;

            await Task.Delay(250);
        }
    }

    private async Task<bool> TryRefreshFromAuthMeAsync()
    {
        try
        {
            using var request = new HttpRequestMessage(HttpMethod.Get, "/.auth/me");

            // Forward the browser's cookies to the server-side call
            var cookieHeader = HttpContextAccessor.HttpContext?.Request.Headers.Cookie.ToString();
            if (!string.IsNullOrWhiteSpace(cookieHeader))
            {
                request.Headers.TryAddWithoutValidation("Cookie", cookieHeader);
            }

            var http = HttpClientFactory.CreateClient();

            // Ensure absolute URL (server-side HttpClient can't use relative URLs reliably)
            var req = HttpContextAccessor.HttpContext?.Request;
            if (req is not null)
            {
                http.BaseAddress = new Uri($"{req.Scheme}://{req.Host}");
            }

            var response = await http.SendAsync(request);
            if (!response.IsSuccessStatusCode)
            {
                _hasEmail = false;
                WindowsCloudUrl = WindowsCloudBaseUrl;
                return false;
            }

            var auth = await response.Content.ReadFromJsonAsync<AuthMeResponse[]>();

            var claims = auth?.FirstOrDefault()?.user_claims;

            var email = claims?
                .FirstOrDefault(c => c.typ == EmailAddressClaimType)
                ?.val;

            if (string.IsNullOrWhiteSpace(email))
            {
                _hasEmail = false;
                WindowsCloudUrl = WindowsCloudBaseUrl;
                return false;
            }

            _hasEmail = true;
            WindowsCloudUrl = $"{WindowsCloudBaseUrl}#loginHint={Uri.EscapeDataString(email)}";
            return true;
        }
        catch
        {
            _hasEmail = false;
            WindowsCloudUrl = WindowsCloudBaseUrl;
            return false;
        }
        finally
        {
            await InvokeAsync(StateHasChanged);
        }
    }

    private sealed class AuthMeResponse
    {
        public ClaimItem[]? user_claims { get; set; }
    }

    private sealed class ClaimItem
    {
        public string? typ { get; set; }
        public string? val { get; set; }
    }
}
